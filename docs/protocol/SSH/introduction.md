---
title: Introduction
sidebar_position: 1
---

- SSH 协议
- SSH Server 实现
- SSH 代理
- SSH 和 TLS 的区别

SSH是英文Secure Shell的简写形式。通过使用SSH，你可以把所有传输的数据进行加密，这样"中间人"这种攻击方式就不可能实现了，而且也能够防止DNS欺骗和IP欺骗。使用SSH，还有一个额外的好处就是传输的数据是经过压缩的，所以可以加快传输的速度。SSH有很多功能，它既可以代替Telnet，又可以为FTP、Pop、甚至为PPP提供一个安全的"通道"。

> note: SSH 协议是一个壳协议，可以理解为包裹，在用户数据的外层包裹一层，使得数据传输是安全的。


## SSH 基本框架

 

SSH协议框架中最主要的部分是三个协议：

 

* 传输层协议（The Transport Layer Protocol）提供服务器认证，数据机密性，信息完整性 等的支持；

* 用户认证协议（The User Authentication Protocol） 则为服务器提供客户端的身份鉴别；

* 连接协议（The Connection Protocol） 将加密的信息隧道复用成若干个逻辑通道，提供给更高层的应用协议使用； 各种高层应用协议可以相对地独立于SSH基本体系之外，并依靠这个基本框架，通过连接协议使用SSH的安全机制。




##### SSH 的工作过程

- 版本号协商阶段
- 秘钥和算法协商阶段
- 认证阶段
- 会话请求阶段
- 交互会话阶段


### 版本号协商阶段

1. SSH 服务端监听 22 端口。
2. 客户端想服务端发起 TCP 连接。
3. 服务端在 TCP 连接建立后，向客户端 发送服务端版本号 `SSH-<主版本号>.<次版本号>-<软件版本号>`。
4. 客户端收到服务端版本号，对比本地SSH客户端版本号，适配，向服务端回复决定使用的版本号。
5. 服务端收到客户端版本号，决定是否与客户端一起工作，否则断开连接。

> note: 我在 wireshark 抓包发现，在建立 TCP 连接之后，是客户端先向服务端发出版本号，然后服务端决定是否与客户端一起工作。值得一提的是版本号协商属于明文传输。


### 秘钥和算法协商阶段

1. 客户端和服务端相互发送 `Key Exchange Init` 报文交换秘钥算法列表，加密算法列表，MAC算法列表，压缩算法列表等。
2. 服务端和客户端根据双方支持的算法列表得到算法使用的算法。
3. 服务端和客户端使用 DH(Diffie-Hellman Exchange) 算法、主机秘钥等对等参数，生成会话秘钥和会话ID。
    - 在认证阶段，双方使用 会话ID 进行认证过程。
    - 对于后续的数据传输过程中，双方使用会话秘钥进行对数据进行加密解密，保证数据的传输安全。

> note: 在协商阶段之前，服务器端已经生成 RSA或 DSA密钥对，他们主要用于参与会话密钥的生成。


### 认证阶段

1. 客户端向服务端发起认证请求，认证中包含用户名，认证方法以及认证方法相关的参数。
2. 服务器端对客户端进行认证，如果认证失败，则向客户端发送认证失败消息，其中包含可以再次认证的方法列表。
3. 客户端从认证方法列表中选取一种认证方法再次进行认证。
4. 该过程反复进行， 直到认证成功或者认证次数达到上限， 服务器关闭连接为止。


**SSH提供四种认证方法：**

1. password 认证：客户端向服务器发出 password认证请求，将用户名和密码加密后发送给服务器；服务器将该信息解密后得到用户名和密码的明文，与设备上保存的用户名和密码进行比较，并返回认证成功或失败的消息。
2. publickey 认证：采用数字签名的方法来认证客户端。目前，设备上可以利用RSA和 DSA两种公共密钥算法实现数字签名。客户端发送包含用户名、公共密钥和公共密钥算法的 publickey 认证请求给服务器端。服务器对公钥进行合法性检查，如果不合法，则直接发送失败消息；否则，服务器利用数字签名对客户端进行认证，并返回认证成功或失败的消息。
3. password-publickey 认证：SSH2认证方法，指定该用户的认证方式为 password 和 publickey认证同时满足。客户端版本为 SSH1的用户只要通过其中一种认证即可登录；客户端版本为 SSH2的用户必须两种认证都通过才能登录。
4. any认证：SSH2认证方法，指定该用户的认证方式可以是 password，也可以是 publickey。



存疑：
1. 对于将本地的 publickey 存放在服务端 `$HOME/.ssh/authorized_keys` 的情况，其认证细节是怎样的呢？



### 会话请求阶段

1. 认证通过后，客户端向服务器发送会话请求；
2. 服务器处理客户端的请求。请求被成功处理后， 服务器会向客户端回应 SSH_SMSG_SUCCESS包，SSH进入交互会话阶段；否则回应 SSH_SMSG_FAILURE包，表示服务器处理请求失败或者不能识别请求。




### 交互会话阶段

在这个模式下，数据被双向传送：

1. 客户端将要执行的命令加密后传给服务器;
2. 服务器接收到报文，解密后执行该命令,将执行的结果加密发还给客户端;
3. 客户端将接收到的结果解密后显示到终端上.


当然 服务端和客户端 对于受到数据的处理主要取决于应用的功能和协议。

















## References

- https://www.cnblogs.com/zmlctt/p/3946860.html












